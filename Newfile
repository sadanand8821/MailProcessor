import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.DocumentBuilder;
import org.w3c.dom.Document;
import org.w3c.dom.NodeList;
import org.w3c.dom.Element;
import java.io.File;
import javax.xml.XMLConstants;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.transform.dom.DOMSource;
import javax.xml.validation.SchemaFactory;
import org.xml.sax.SAXException;
import java.io.IOException;

public class JacocoReportParser {
    public static void main(String[] args) {
        try {
            File xmlFile = new File("C:/Users/K046970/Downloads/JacocoFiles/xml/sample.xml");
            DocumentBuilderFactory dbFactory = DocumentBuilderFactory.newInstance();

            // Disable DTD validation
            dbFactory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);
            dbFactory.setFeature("http://xml.org/sax/features/namespaces", false);
            dbFactory.setFeature("http://xml.org/sax/features/validation", false);
            dbFactory.setFeature("http://apache.org/xml/features/nonvalidating/load-dtd-grammar", false);
            dbFactory.setFeature("http://apache.org/xml/features/nonvalidating/load-external-dtd", false);

            DocumentBuilder dBuilder = dbFactory.newDocumentBuilder();
            Document doc = dBuilder.parse(xmlFile);
            doc.getDocumentElement().normalize();

            NodeList packageList = doc.getElementsByTagName("package");

            for (int i = 0; i < packageList.getLength(); i++) {
                Element packageElement = (Element) packageList.item(i);
                String packageName = packageElement.getAttribute("name");

                NodeList classList = packageElement.getElementsByTagName("class");

                for (int j = 0; j < classList.getLength(); j++) {
                    Element classElement = (Element) classList.item(j);
                    String className = classElement.getAttribute("name");

                    NodeList methodList = classElement.getElementsByTagName("method");

                    for (int k = 0; k < methodList.getLength(); k++) {
                        Element methodElement = (Element) methodList.item(k);
                        String methodName = methodElement.getAttribute("name");
                        String methodDesc = methodElement.getAttribute("desc");
                        int coveredInstructions = 0;
                        int missedInstructions = 0;
                        int totalInstructions = 0;

                        NodeList counterList = methodElement.getElementsByTagName("counter");
                        for (int l = 0; l < counterList.getLength(); l++) {
                            Element counterElement = (Element) counterList.item(l);
                            String type = counterElement.getAttribute("type");

                            if ("INSTRUCTION".equals(type)) {
                                coveredInstructions = Integer.parseInt(counterElement.getAttribute("covered"));
                                missedInstructions = Integer.parseInt(counterElement.getAttribute("missed"));
                                totalInstructions = coveredInstructions + missedInstructions;
                            }
                        }

                        // Use the coveredInstructions as an approximation for method invocation count
                        System.out.println("Package: " + packageName);
                        System.out.println("Class: " + className);
                        System.out.println("Method: " + methodName + methodDesc);
                        System.out.println("Total Instructions: " + totalInstructions);
                        System.out.println("Covered Instructions: " + coveredInstructions);
                        System.out.println("Missed Instructions: " + missedInstructions);
                        System.out.println("Invocation Count (approx.): " + coveredInstructions);
                        System.out.println("---------------------------");
                    }
                }
            }
        } catch (ParserConfigurationException | SAXException | IOException e) {
            e.printStackTrace();
        }
    }
}
